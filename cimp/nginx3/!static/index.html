<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="static/css/semantic.min.css">
    <link rel="stylesheet" href="static/css/custom.css">

    <script src="static/js/jquery-3.5.1.min.js" charset="utf-8"></script>
    <script src="static/js/semantic.min.js" charset="utf-8"></script>
    <script src="static/js/vue-2.6.11.min.js" charset="utf-8"></script>
    <title>校园信息管理平台</title>
</head>
<body>
    <div id="container">
        <!-- 导航 -->
        <nav class="ui inverted attached segment m-shadow-small">
            <div class="ui container">
                <div class="ui inverted secondary stackable menu m-padded-tb-mini">
                    <h2 class="ui teal header item">CIMP</h2>
                    <a href="/" class="item active m-mobile-hide m-item"><i class="home icon"></i>首页</a>
                    <a href="show/articles.html" class="item m-mobile-hide m-item"><i class="idea icon"></i>优秀论文</a>
                    <a href="show/news.html" class="item m-mobile-hide m-item"><i class="clone icon"></i>校园新闻</a>
                    <a href="show/notices.html" class="item m-mobile-hide m-item"><i class="info icon"></i>通知公告</a>
                    <!-- 搜索
                    <div class="right item m-mobile-hide m-item">
                        <div class="ui icon inverted transparent input">
                            <input type="text" placeholder="Search...">
                            <i class="search link icon"></i>
                        </div>
                    </div>
                    -->
                    <div class="right m-mobile-hide item m-item">
                        <a v-if="!localStorage.token" href="/login.html" class="ui primary button">注册/登录</a>
                        <div v-if="localStorage.token" class="item m-mobile-hide m-item"><i class="user icon"></i>{{ 当前在线用户的用户名 }}</div>
                        <a v-if="localStorage.用户类型==1 || localStorage.用户类型==2" href="/manage" class="item m-mobile-hide m-item"><i class="users icon"></i>后台管理</a>
                        <a v-if="localStorage.用户类型==2" href="/manage/articleaudit.html" class="item m-mobile-hide m-item"><i class="eraser icon"></i>论文审批</a>
                        <a v-if="localStorage.用户类型==3" href="/manage/articlepublic.html" class="item m-mobile-hide m-item"><i class="file pdf icon"></i>论文提交</a>
                        <a v-if="localStorage.token" @click.prevent="logout()" class="item m-mobile-hide m-item"><i class="power off icon"></i>退出登录</a>
                    </div>
                </div>
            </div>
            <a class="ui menu toggle black icon button m-top-right m-mobile-show" v-on:click="sidebar">
                <i class="sidebar icon"></i>
            </a>
        </nav>

        <!-- 中间内容 -->
        <div class="m-padded-tb-big">
            <div class="ui container">
                <div class="ui stackable grid">
                    <!-- 左侧列表 -->
                    <div class="eleven wide column">
                        <!-- 列表头 -->
                        <div class="ui top attached segment">
                            <div class="ui middle aligned two column grid">
                                <div class="column">
                                    <h3 class="ui header teal">优秀论文</h3>
                                </div>
                                <div class="right aligned column">
                                    共<h2 class="ui orange header m-inline-blok m-text-thin">{{ 论文列表.论文总数 }}</h2>篇
                                </div>
                            </div>
                        </div>
                        <!-- 列表 -->
                        <div class="ui attached segment animated">

                            <!-- 一条博客记录 -->
                            <div class="ui vertical segment m-padded-tb-large m-padded-lr" v-for="论文 in 论文列表">
                                <div class="ui mobile reversed stackable grid">
                                    <!-- 文章内容摘要 -->
                                    <div class="eleven wide column">
                                        <h3 class="ui header">{{ 论文.论文主题 }}</h3>
                                        <p v-html="论文.论文内容"></p>
                                        <div class="ui stackable grid">
                                            <div class="eleven wide column">
                                                <div class="ui mini horizontal link list">
                                                    <div class="item">
                                                        <img src="static/img/profile.jpg" alt="" class="ui avatar image">
                                                        <div class="content"><a href="#" class="header">{{ 论文.论文作者真实姓名 }}</a></div>
                                                    </div>
                                                    <div class="item">
                                                        <i class="calendar icon"></i>{{ 论文.发布时间 }}
                                                    </div>
                                                    <!-- <div class="item">
                                                        <i class="eye icon"></i>33
                                                    </div> -->
                                                </div>
                                            </div>
                                            <div class="right aligned five wide column">
                                                <a :href="'/show/article.html?no=' + 论文.id" target="_blank" class="ui teal basic label m-padded-tiny m-text-thin">论文细节</a>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 文章首图 -->
                                    <div class="five wide column" v-if="论文.论文头图==-1">
                                        <a>
                                            <img src="/static/img/test.jpg" alt="" class="ui rounded image">
                                        </a>
                                    </div>
                                    <div class="five wide column" v-if="论文.论文头图!=-1">
                                        <a>
                                            <img :src="论文.论文头图" alt="" class="ui rounded image">
                                        </a>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <!-- 博客列表底部 start-->
                        <div class="ui bottom attached segment">
                            <div class="right column">
                                <a href="show/articles.html" class="ui mini teal basic button">查看更多</a>
                            </div>
                            <!--<div class="ui middle aligned two column grid">
                                <div class="column">
                                    <a href="#" class="ui mini teal basic button">上一页</a>
                                </div>
                                <div class="right aligned column">
                                    <a href="#" class="ui mini teal basic button">下一页</a>
                                </div>
                            </div>-->
                        </div>
                        <!-- 博客列表底部 end-->
                    </div>
                    <!-- 右边卡片 -->
                    <div class="five wide column">
                        <!-- 标签卡片 -->
                        <div class="ui segments">
                            <!-- 卡片标题 -->
                            <div class="ui secondary segment">
                                <div class="ui two column grid">
                                    <div class="column"><i class="clone icon"></i>校园新闻</div>
                                    <div class="right aligned column"><a href="show/news.html">更多 <i class="angle double right icon"></i></a></div>
                                </div>
                            </div>
                            <!-- 标签列表 -->
                            <div class="ui teal segment" style="margin-bottom: -3em; z-index: -1;"></div>
                            <div class="ui divided selection list">
                                <!-- 单个标签 -->
                                <a class="item" v-for="新闻 in 新闻列表" :href="'/show/new.html?no=' + 新闻.id" target="_blank">
                                    <div class="ui black ribbon label">{{ 新闻.新闻标题 }}</div><br>
                                    <div class="ui right ribbon label"><i class="time icon"></i>{{ 新闻.发布时间 }}</div>
                                </a>
                                <!-- 单个标签 -->
                            </div>
                            <!-- 标签列表 -->
                        </div>
                        <!-- 标签卡片 -->
                        <!-- 分类卡片 -->
                        <div class="ui segments m-margin-top-large">
                            <!-- 卡片标题 -->
                            <div class="ui secondary segment">
                                <div class="ui two column grid">
                                    <div class="column"><i class="info icon"></i>通知公告</div>
                                    <div class="right aligned column"><a href="show/notices.html">更多 <i class="angle double right icon"></i></a></div>
                                </div>
                            </div>
                            <!-- 卡片内容 -->
                            <div class="ui teal segment">
                                <div class="ui divided selection list">
                                    <!-- 一条内容 -->
                                    <a :href="'/show/notice.html?no=' + 通知.id" target="_blank" class="item" v-for="通知 in 通知列表">
                                        {{ 通知.通知标题 }}
                                        <div class="ui right floated teal basic left pointing label" style="margin-top: 0.5em;">{{ 通知.发布时间 }}</div>
                                    </a>
                                    <!-- 一条内容 -->
                                </div>
                            </div>
                            <!-- 卡片内容 -->
                        </div>
                        <!-- 分类卡片 -->
                    </div>
                </div>
            </div> 
        <!--  -->
        </div>

        <!-- 底部 -->
        <div id="footer"></div>
        <script>
            $(function(){
                $('#footer').load('static/footer.html')
            })
        </script>
        <!-- 底部 -->
    </div>

    <script>
        let app = new Vue({
            el: '#container',
            data: {
                当前在线用户的用户名: localStorage.用户名,
                新闻列表: [],
                通知列表: [],
                论文列表: [],
                显示在页面上的新闻个数: 4,
                显示在页面上的通知个数: 4,
                显示在页面上的论文个数: 4,
            },
            created() {
                fetch('/api/news?pagesize='+this.显示在页面上的新闻个数+'&pageno=1', {
                    headers: {
                        'content-type': 'application/json',
                    }
                }).then(resp => resp.json()).then(json => {
                    for (i=0; i<json.新闻列表.length; i++){
                        json.新闻列表[i].发布时间 = json.新闻列表[i].发布时间.split('T')[0]
                    }
                    this.新闻列表 = json.新闻列表
                })

                fetch('/api/notice?pagesize='+this.显示在页面上的通知个数+'&pageno=1', {
                    headers: {
                        'content-type': 'application/json',
                    }
                }).then(resp => resp.json()).then(json => {
                    for (i=0; i<json.通知列表.length; i++){
                        json.通知列表[i].发布时间 = json.通知列表[i].发布时间.split('T')[0]
                        json.通知列表[i].通知标题 = this.删除论文头图(json.通知列表[i].通知标题)
                        json.通知列表[i].通知标题 = json.通知列表[i].通知标题.substr(0,100) + "……"
                    }
                    this.通知列表 = json.通知列表
                })

                fetch('/api/articles?pagesize='+this.显示在页面上的论文个数+'&pageno=1', {
                    headers: {
                        'content-type': 'application/json',
                    }
                }).then(resp => resp.json()).then(json => {
                    for (i=0; i<json.论文列表.length; i++){
                        json.论文列表[i].发布时间 = json.论文列表[i].发布时间.split('T')[0]
                        json.论文列表[i].论文头图 = this.获取论文头图(json.论文列表[i].论文内容)
                        json.论文列表[i].论文内容 = this.删除论文头图(json.论文列表[i].论文内容)
                        json.论文列表[i].论文内容 = json.论文列表[i].论文内容.substr(0,100) + "……"
                    }
                    this.论文列表 = json.论文列表
                    this.论文列表.论文总数 = json.论文总数
                })

            },
            methods: {
                sidebar() {
                    // 移动端，导航页开启关闭
                    $(".m-item").toggleClass('m-mobile-hide');
                },
                logout() {
                    localStorage.clear()
                    this.当前在线用户的用户名 = ''
                },
                获取论文头图(text) {
                    var a = text.indexOf("<img src=")
                    if (a == -1){
                        return a
                    }
                    text = text.slice(a+10)
                    a = text.indexOf("\"")
                    text = text.slice(0,a)
                    return text
                },
                删除论文头图(text) {
                    var a = text.indexOf("<p><img")
                    if (a == -1){
                        return text
                    }
                    var front = text.slice(0,a)
                    var behindself = text.slice(a)
                    a = behindself.indexOf("</p>")
                    var behind = behindself.slice(a+4)
                    text = front + behind
                    return text
                }
            }
        })
    </script>
</body>
</html>