<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/css/semantic.min.css">
    <link rel="stylesheet" href="../static/css/custom.css">

    <script src="../static/js/jquery-3.5.1.min.js" charset="utf-8"></script>
    <script src="../static/js/semantic.min.js" charset="utf-8"></script>
    <script src="../static/js/vue-2.6.11.min.js" charset="utf-8"></script>
    <title>论文审批</title>
</head>
<body>
    <div id="container">
        <!-- 导航 -->
        <nav class="ui inverted attached segment m-shadow-small">
            <div class="ui container">
                <div class="ui inverted secondary stackable menu m-padded-tb-mini">
                    <h2 class="ui teal header item">CIMP</h2>
                    <a href="/" class="item active m-mobile-hide m-item"><i class="home icon"></i>首页</a>
                    <a href="/show/articles.html" class="item m-mobile-hide m-item"><i class="idea icon"></i>优秀论文</a>
                    <a href="/show/news.html" class="item m-mobile-hide m-item"><i class="clone icon"></i>校园新闻</a>
                    <a href="/show/notices.html" class="item m-mobile-hide m-item"><i class="info icon"></i>通知公告</a>
                    <div class="right m-mobile-hide item m-item">
                        <div v-if="localStorage.token" class="item m-mobile-hide m-item"><i class="user icon"></i>{{ localStorage.用户名 }}</div>
                    </div>
                </div>
            </div>
            <a class="ui menu toggle black icon button m-top-right m-mobile-show" v-on:click="sidebar">
                <i class="sidebar icon"></i>
            </a>
        </nav>

        <!-- 中间内容  start-->
        <div class="m-padded-tb-big m-container-small">
            <h1 v-show="待审批主题的总数==0" class="ui green header m-inline-blok m-text-thin">暂时没有需要审批的主题</h1>
            <div class="ui fluid card" v-show="待审批主题的总数!=0">
                <div class="content">
                    <div class="ui header">待审批主题(剩余{{ 待审批主题的总数-1 }}个)：</div>
                    <h1 class="ui blue header">{{ 待审批主题的论文主题 }}</h1>
                </div>
                <div style="padding-left: 1em;margin-bottom: 1em;padding-right: 1em">
                    <div style="color: green">主题描述：</div><hr>
                    <div v-html='待审批主题的主题描述'></div><hr>
                    <div style="color: green">审批理由：</div>
                </div>
                <div id="div1" style="padding-left: 1em;margin-right: 1em;">
                    <p>该主题很好……</p>
                </div>
                <div class="extra content">
                    <div class="ui two buttons">
                        <div class="ui basic green button" @click="是否通过主题(3)">通过主题</div>
                        <div class="ui basic red button" @click="是否通过主题(2)">驳回主题</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="m-padded-tb-big m-container-small">
            <h1 v-show="待审批论文的总数==0" class="ui green header m-inline-blok m-text-thin">暂时没有需要审批的论文</h1>
            <div class="ui fluid card" v-show="待审批论文的总数!=0">
                <div class="content">
                    <div class="ui header">待审批论文(剩余{{ 待审批论文的总数-1 }}个)：</div>
                    <h1 class="ui blue header">{{ 待审批论文的论文主题 }}</h1>
                </div>
                <div style="padding-left: 1em;margin-bottom: 1em;padding-right: 1em">
                    <div style="color: green">论文内容：</div><hr>
                    <div v-html='待审批论文的论文内容'></div><hr>
                    <div style="color: green">审批理由：</div>
                </div>
                <div id="div2" style="padding-left: 1em;margin-right: 1em">
                    <p>该论文很好……</p>
                </div>
                <div class="extra content">
                    <div class="ui right labeled left icon input">
                        <i class="thumbs up outline icon"></i>
                        <input v-model="论文评分" type="text" placeholder="输入分数">
                        <a class="ui basic right attached green button" @click="是否通过论文(6)">
                            通过论文
                        </a>
                    </div>
                    <div class="ui basic red button" @click="是否通过论文(5)">驳回论文</div>
                </div>
            </div>
        </div>
        <!-- 中间内容 end-->

        <!-- 底部 -->
        <div id="footer"></div>
        <script>
            $(function(){
                $('#footer').load('../static/footer.html')
            })
        </script>
        <!-- 底部 -->
    </div>

    <script>
        let app = new Vue({
            el: '#container',
            data: {
                待审批主题id: 0,
                待审批主题的论文主题: '',
                待审批主题的主题描述:'',
                待审批主题的总数:0,
                待审批论文id: 0,
                待审批论文的论文主题:'',
                待审批论文的论文内容:'',
                待审批论文的总数:0,
                论文评分:null
            },
            created() {
                this.获取待审批主题()
                this.获取待审批论文()
            },
            methods: {
                sidebar() {
                    // 移动端，导航页开启关闭
                    $(".m-item").toggleClass('m-mobile-hide');
                },
                获取待审批主题(){
                    fetch('/api/prethemeslist', {
                    headers: {
                        'content-type': 'application/json',
                        'token': localStorage.token,
                    }
                    }).then(resp => resp.json()).then(json => {
                        if (json.code == 200){
                            this.待审批主题id = json.id
                            this.待审批主题的总数 = json.total
                            this.待审批主题的论文主题 = json.论文主题
                            this.待审批主题的主题描述 = json.主题描述
                        }else {
                            alert(json.message)
                        }
                    })
                },
                获取待审批论文(){
                    fetch('/api/prearticleslist', {
                    headers: {
                        'content-type': 'application/json',
                        'token': localStorage.token,
                    }
                    }).then(resp => resp.json()).then(json => {
                        if (json.code == 200){
                            this.待审批论文id = json.id
                            this.待审批论文的总数 = json.total
                            this.待审批论文的论文主题 = json.论文主题
                            this.待审批论文的论文内容 = json.论文内容
                        }else {
                            alert(json.message)
                        }
                    })
                },
                是否通过主题(action){
                    // action 为3则通过主题，2为驳回主题
                    fetch('/api/workstream', {
                        method: 'post',
                        body: JSON.stringify({
                            '论文状态事件': action,
                            '事件描述': editor.txt.html(),
                            'id': this.待审批主题id
                        }),
                        headers: {
                            'content-type': 'application/json',
                            'token': localStorage.token,
                        }
                    }).then(resp => resp.json()).then(json => {
                        if (json.code == 200){
                            alert(json.message)
                            location.href = location.href
                        }else {
                            alert(json.message)
                        }
                    })
                },
                是否通过论文(action){
                    // action 为6则通过论文，5为驳回论文
                    if (action == 6 && !parseInt(this.论文评分)){
                        alert("你还没有输入分数！")
                        return 0;
                    }
                    fetch('/api/workstream', {
                        method: 'post',
                        body: JSON.stringify({
                            '论文状态事件': action,
                            '事件描述': editor2.txt.html(),
                            'id': this.待审批论文id,
                            '论文评分': this.论文评分
                        }),
                        headers: {
                            'content-type': 'application/json',
                            'token': localStorage.token,
                        }
                    }).then(resp => resp.json()).then(json => {
                        if (json.code == 200){
                            alert(json.message)
                            location.href = location.href
                        }else {
                            alert(json.message)
                        }
                    })
                },
            }
        })
    </script>
</body>
<script type="text/javascript" src="../static/js/wangEditor-4.6.9.min.js"></script>
<script type="text/javascript">
    const E = window.wangEditor
    const editor = new E("#div1")
    //设置编辑区高度，默认300
    editor.config.height = 100
    //上传服务器接口地址
    editor.config.uploadImgServer = '/api/upload'
    //限制一次最多能传几张图片(默认是100张)
    editor.config.uploadImgMaxLength = 9
    //自定义 fileName
    editor.config.uploadFileName = 'upload'
    //上传图片时添加 http 请求的 header
    editor.config.uploadImgHeaders = {Token: localStorage.token, }
    //隐藏插入网络图片的功能，即只保留上传本地图片
    editor.config.showLinkImg = false
    //网络图片设置alt和跳转链接
    editor.config.showLinkImgAlt = false
    editor.config.showLinkImgHref = false
    editor.create()

    const E2 = window.wangEditor
    const editor2 = new E2("#div2")
    editor2.config.height = 100
    editor2.config.uploadImgServer = '/api/upload'
    editor2.config.uploadImgMaxLength = 9
    editor2.config.uploadFileName = 'upload'
    editor2.config.uploadImgHeaders = {Token: localStorage.token, }
    editor2.config.showLinkImg = false
    editor2.config.showLinkImgAlt = false
    editor2.config.showLinkImgHref = false
    editor2.create()
</script>
</html>